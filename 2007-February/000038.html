<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [jjack-users] comparing JJack and JavaSound, measuring latency
   </TITLE>
   <LINK REL="Index" HREF="http://lists.berlios.de/pipermail/jjack-users/2007-February/index.html" >
   <LINK REL="made" HREF="mailto:jjack-users%40lists.berlios.de?Subject=Re%3A%20%5Bjjack-users%5D%20comparing%20JJack%20and%20JavaSound%2C%20measuring%20latency&In-Reply-To=%3C45DFA8E0.4020201%40jensgulden.de%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="000037.html">
   <LINK REL="Next"  HREF="000039.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[jjack-users] comparing JJack and JavaSound, measuring latency</H1>
    <B>Jens Gulden</B> 
    <A HREF="mailto:jjack-users%40lists.berlios.de?Subject=Re%3A%20%5Bjjack-users%5D%20comparing%20JJack%20and%20JavaSound%2C%20measuring%20latency&In-Reply-To=%3C45DFA8E0.4020201%40jensgulden.de%3E"
       TITLE="[jjack-users] comparing JJack and JavaSound, measuring latency">mail at jensgulden.de
       </A><BR>
    <I>Sat Feb 24 03:54:24 CET 2007</I>
    <P><UL>
        <LI>Previous message: <A HREF="000037.html">[jjack-users] comparing JJack and JavaSound, measuring latency
</A></li>
        <LI>Next message: <A HREF="000039.html">[jjack-users] comparing JJack and JavaSound, measuring latency
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#38">[ date ]</a>
              <a href="thread.html#38">[ thread ]</a>
              <a href="subject.html#38">[ subject ]</a>
              <a href="author.html#38">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hello,

Peter Salomonsen wrote:
 &gt; We have a test benchmark program we used for this in 
com.frinika.audio.benchmark.RecordInputRoundtripLatencyTest

Thanks again for the hint. I used this piece of code as an entry point for teaching me how to deploy 
JavaSound. Then I made my own benchmark tool, because I thought one might get more accurate results 
if 2 machines are used for measuring latency: one for generating the audio signal, and one for 
measuring the delay between issuing that request and the appearance of the audio signal. (The 
disadvantage of this apprach is that you necessarily add more latency through the 
recording/measuring machine, but that's ok as long as your aim is comparing different setups and not 
getting absolute values.)

General question: Is my approach valid? More details below.

The two most surprising results are:

1) there's a dramatic improve of JavaSound both on Linux and Windows since jdk 1.5 (the 
horror-stories on 200ms latency have obviously been true in times of jdk1.4, but it has improved a lot)

2) JavaSound seems to be more liable to different hardware and system-configurations: JACK/JJack 
behaves more stable with respect to providing equal latency for different underlying hardware, while 
JavaSound sometimes succeeds in achieving very low latency with the tested onboard-audio-hardware 
(Intel 82801), but falls behind the use of JJack when the tested USB-audio-hardware (Aardvark 
DirectUSB) is deployed. Depeding on the Linux configuration, there had been high differences in 
latency when using the USB-audio-device.

A table with results is attached as PDF.

I've added the benchmark tool to JJack's CVS-repository, class 
de.gulden.framework.jjack.util.benchmark.AudioBenchmark.

More details:
Machine A is a Pentium M 1400MHz, using either the onboard-sound-card (Intel 82801) or an external 
USB-audio-interface (Aardvark DirectMix USB3). The latency of this setup is being measured each 
under a Linux 2.6.15-non-realtime kernel, a 2.6.15-4-realtime kernel, and Windows XP. All three JDK 
versions 1.4, 1.5 and 1.6 get utilized, each one in combination which each device and each operating 
system either using JJack (on Linux) or JavaSound output. Machine B is a AMD 800Mhz running a 
2.6.15-4-realtime Linux (Musix 0.39) and JDK 1.5, this second machine performs the measuring by 
recording and subsequently analyzing the audio signal generated by machine A in all different setups.
Both machines have been connected via ethernet, using a direct-link cable (a &#8222;crossed&#8220; ethernet 
cable) which minimizes network latency by avoiding any hubs or ip-switches on the way between the 
machines. The ICMP-ping times reported by the &#8222;ping&#8220;-command result in 0.2 ms and less, so 
network-transmission latency does not significantly distort the measured results. The audio-output 
of machine A is connected to the audio input of machine B via an analog (zero-latency .-) cable.

On the software-side, a benchmark application has been written that either runs in server-mode on 
the machine of which the audio-latency is to be measured (machine A), or in client-mode on the 
machine which performs the measuring (machine B). The benchmark application has been made part of 
the JJack package (available via CVS), in class de.gulden.framework.jjack.util.benchmark.AudioBenchmark.
When run in server mode, the program first initializes the required audio-output device (either via 
JJack or JavaSound), and then puts itself to sleep by waiting on a UDP network data-package to 
arrive on port 7777. Once this UDP-package has been received, the program immediately outputs 100 ms 
of a full-amplitude square signal with an period length of 100 frames. Reacting on the UDP-package 
has been implemented to happen as soon as possible, both in JJack and JavaSound mode, although the 
ways of achieving the lowest possible reaction time fudamentally differ in JJack and JavaSound due 
to the principle difference of a pull-architecture in JACK/JJack and a push-architecture in 
JavaSound. Once the audio output has been generate, the program waits 100 ms and loops back to 
waiting for an UDP-package until it gets manually stopped.
When running in client mode, the program initializes audio-input via JJack and starts recording of 
one second, then waits 100 ms, issues a UDP-package to port 7777 on the server machine and remembers 
the amount of empty audio data recorded until the UDP-packge has been sent, waits until the record 
buffer is filled, cuts off the beginning part recorded before the UDP-package was actually sent, and 
then searches the recorded audio for the occurrence of a sequence of at least 10 amplitude values 
above 0.2, which is interpreted as the beginning of the received square waveform signal. The time of 
&#8222;empty&#8220; audio data until the waveform begins is calculated and output as latency time.
Note that this way of measuring of course also includes latency induced by other origins (e.g. 
little network overhead, which, however, can be considered less with the UDP-ping method than with 
any custom Midi-device in a real-world realtime-audio application) and of course the latency of the 
recording audio-input on the client machine. However, the method appears suitable for comparing 
different combinatios of audio APIs, Java versions, operating systems and hardware to get 
information on how they relatively compare to each other.
The JACK server has been run in playback-only mode on the server, and in capture-only mode on the 
client. Duplex-mode has not been measured.

So, what do you think, are the results plausible? Thanks for comments,
Jens



Jens Gulden schrieb:
&gt;<i> Hello,
</I>&gt;<i> 
</I>&gt;<i> several people have reported big differences in latency between using JavaSound and JJack. JavaSound 
</I>&gt;<i> seems to regularly cause latency of about 200ms.
</I>&gt;<i> 
</I>&gt;<i> Is there an easy way to measure the latency of JavaSound (some piece of Java code + &quot;latency 
</I>&gt;<i> measurig tool&quot;, or something)? How would a small test setup look like?
</I>&gt;<i> I have never used JavaSound for audio before, so I'm very thankful for hints.
</I>&gt;<i> 
</I>&gt;<i> What other fundamental differences between JavaSound and JJack are there?
</I>&gt;<i> 
</I>&gt;<i> (I'm currently writing a paper about JJack for the Linux Audio Conference LAC '07. The paper is 
</I>&gt;<i> already accepted as a contribution to the conference, and now I want to improve it by adding 
</I>&gt;<i> benchmarks comparing JavaSound and JJack. I'll make a post to this list when the paper is available.)
</I>&gt;<i> 
</I>&gt;<i> Many thanks in advance,
</I>&gt;<i> Jens
</I>&gt;<i> _______________________________________________
</I>&gt;<i> jjack-users mailing list
</I>&gt;<i> <A HREF="https://lists.berlios.de/mailman/listinfo/jjack-users">jjack-users at lists.berlios.de</A>
</I>&gt;<i> <A HREF="https://lists.berlios.de/mailman/listinfo/jjack-users">https://lists.berlios.de/mailman/listinfo/jjack-users</A>
</I>
-------------- next part --------------
A non-text attachment was scrubbed...
Name: benchmarks-20070223.pdf
Type: application/pdf
Size: 26416 bytes
Desc: not available
URL: &lt;<A HREF="https://lists.berlios.de/pipermail/jjack-users/attachments/20070224/a4e562f3/attachment.pdf">https://lists.berlios.de/pipermail/jjack-users/attachments/20070224/a4e562f3/attachment.pdf</A>&gt;
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="000037.html">[jjack-users] comparing JJack and JavaSound, measuring latency
</A></li>
	<LI>Next message: <A HREF="000039.html">[jjack-users] comparing JJack and JavaSound, measuring latency
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#38">[ date ]</a>
              <a href="thread.html#38">[ thread ]</a>
              <a href="subject.html#38">[ subject ]</a>
              <a href="author.html#38">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.berlios.de/mailman/listinfo/jjack-users">More information about the jjack-users
mailing list</a><br>
</body></html>
